name: '❌ Open-Issue Reminder'

on:
  schedule:
    - cron: '0 0 * * 1,4' # Every Monday and Thursday at 00:00 UTC

jobs:
  remind-open-issues:
    runs-on: ubuntu-latest
    name: 'Notify About Open Issues'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch and Remind Open Issues
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 🌼 Bharat-Bhakti-Yatra — Issue Reminder Workflow
            // This script reminds contributors about open issues and adds a "reminder-sent" label.

            const { owner, repo } = context.repo;

            console.log("🕉️ Running Bharat-Bhakti-Yatra Issue Reminder Workflow...");

            // Fetch all open issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              per_page: 100,
            });

            if (!issues.length) {
              console.log("✅ No open issues today. The repository is in divine harmony!");
              return;
            }

            console.log(`📌 Found ${issues.length} open issue(s). Preparing to send gentle reminders...`);

            for (const issue of issues) {
              // Skip Pull Requests (they appear in issues API)
              if (issue.pull_request) continue;

              const issueNumber = issue.number;
              const issueTitle = issue.title;
              const issueUrl = issue.html_url;
              const assignees =
                issue.assignees.map((a) => `@${a.login}`).join(", ") || "Unassigned";

              // 🌺 Build a thoughtful reminder message
              const message = `
              🌸 **Namaste ${assignees}!**

              This is a gentle reminder that the following issue is still open:  
              🔗 [#${issueNumber} — ${issueTitle}](${issueUrl})

              🙏 Please update us if:
              - You’re currently working on it  
              - You need help or additional context  
              - It can be closed after recent changes  

              🕊️ Let's keep our contribution flow active and harmonious.  
              *May our collective efforts continue to guide Bharat-Bhakti-Yatra toward unity and growth!* ✨
              `;

              // Post the reminder comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: message.trim(),
              });

              console.log(`✅ Reminder posted on issue #${issueNumber}`);

              // Add "reminder-sent" label if not already present
              const labelExists = issue.labels.some((l) => l.name === "reminder-sent");
              if (!labelExists) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  labels: ["reminder-sent"],
                });
                console.log(`🏷️ Added 'reminder-sent' label to issue #${issueNumber}`);
              }
            }

            console.log("🌺 All reminders sent with devotion and care. Jai Bharat! 🇮🇳");

      - name: Workflow Complete
        run: echo "🎉 All open issues processed successfully!"
